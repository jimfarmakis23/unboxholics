name: Î‘Ï…Ï„ÏŒÎ¼Î±Ï„Î· ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ· links.txt Î±Ï€ÏŒ YouTube RSS

on:
  schedule:
    # Î¤ÏÎ­Ï‡ÎµÎ¹ ÎºÎ¬Î¸Îµ ÏÏÎ± (ÏƒÏ„Î¿ Î»ÎµÏ€Ï„ÏŒ 0)
    - cron: '1 * * * *'
  workflow_dispatch: # Î£Î¿Ï… ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÎ¹ Î½Î± Ï„Î¿ Ï„ÏÎ­Î¾ÎµÎ¹Ï‚ ÎºÎ±Î¹ Î¼Îµ Ï„Î¿ Ï‡Î­ÏÎ¹ Î±Ï€ÏŒ Ï„Î¿ GitHub

permissions:
  contents: write

jobs:
  update-links:
    runs-on: ubuntu-latest
    steps:
      - name: ÎšÎ±Ï„Î­Î²Î±ÏƒÎ¼Î± repository
        uses: actions/checkout@v4

      - name: Î’ÏÎµÏ‚ Ï„Î¿ Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Î¿ Î²Î¯Î½Ï„ÎµÎ¿ Î±Ï€ÏŒ Ï„Î¿ RSS
        id: get_video
        run: |
          # Î¤ÎŸ Î”Î™ÎšÎŸ Î£ÎŸÎ¥ RSS FEED
          CHANNEL_ID="UCMiJRAwDNSNzuYeN2uWa0pA"
          RSS_URL="https://www.youtube.com/feeds/videos.xml?channel_id=${CHANNEL_ID}"
          
          echo "Î”Î¹Î±Î²Î¬Î¶Ï‰ Ï„Î¿ RSS Î±Ï€ÏŒ: $RSS_URL"
          
          # ÎšÎ±Ï„Î­Î²Î±ÏƒÎµ Ï„Î¿ RSS ÎºÎ±Î¹ Î²Î³Î¬Î»Îµ Ï„Î¿ Ï€Î¹Î¿ Ï€ÏÏŒÏƒÏ†Î±Ï„Î¿ link
          LATEST_URL=$(curl -s "$RSS_URL" | grep -oP '(?<=<link rel="alternate" href=")[^"]+' | head -1)
          
          if [ -z "$LATEST_URL" ]; then
            echo "âŒ Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ link ÏƒÏ„Î¿ RSS"
            exit 1
          fi
          
          echo "âœ… Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯Î¿ Î²Î¯Î½Ï„ÎµÎ¿: $LATEST_URL"
          echo "LATEST_URL=${LATEST_URL}" >> $GITHUB_OUTPUT

      - name: ÎˆÎ»ÎµÎ³Î¾Îµ ÎºÎ±Î¹ ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎµ Ï„Î¿ links.txt
        env:
          LATEST_LINK: ${{ steps.get_video.outputs.LATEST_URL }}
        run: |
          FILE="data/links.txt"
          
          # Î‘Î½ Ï„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹, Î´Î·Î¼Î¹Î¿ÏÏÎ³Î·ÏƒÎ­ Ï„Î¿
          if [ ! -f "$FILE" ]; then
            echo "ğŸ“ Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ Î±ÏÏ‡ÎµÎ¯Î¿. Î¤Î¿ Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Ï..."
            mkdir -p data
            echo "$LATEST_LINK" > "$FILE"
            echo "âœ… Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î®Î¸Î·ÎºÎµ Î¼Îµ Ï„Î¿ Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Î¿ link."
            exit 0
          fi
          
          # Î”Î¹Î¬Î²Î±ÏƒÎµ Ï„Î·Î½ Ï€ÏÏÏ„Î· Î³ÏÎ±Î¼Î¼Î® (Ï„Î¿ Ï€Î¹Î¿ Ï€ÏÏŒÏƒÏ†Î±Ï„Î¿ link Ï€Î¿Ï… Î­Ï‡ÎµÎ¹Ï‚ Î®Î´Î·)
          FIRST_LINE=$(head -n 1 "$FILE")
          
          # Î‘Î½ Ï„Î¿ link Î±Ï€ÏŒ Ï„Î¿ RSS ÎµÎ¯Î½Î±Î¹ Î¯Î´Î¹Î¿, Î¼Î·Î½ ÎºÎ¬Î½ÎµÎ¹Ï‚ Ï„Î¯Ï€Î¿Ï„Î±
          if [ "$FIRST_LINE" = "$LATEST_LINK" ]; then
            echo "â¸ï¸  Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î½Î­Î¿ Î²Î¯Î½Ï„ÎµÎ¿. ÎšÎ±Î½Î­Î½Î± update."
            exit 0
          fi
          
          # Î‘Î½ ÎµÎ¯Î½Î±Î¹ Î´Î¹Î±Ï†Î¿ÏÎµÏ„Î¹ÎºÏŒ (Î½Î­Î¿ Î²Î¯Î½Ï„ÎµÎ¿), Ï€ÏÏŒÏƒÎ¸ÎµÏƒÎ­ Ï„Î¿ ÏƒÏ„Î·Î½ Î±ÏÏ‡Î®
          echo "ğŸ‰ ÎÎ•ÎŸ Î’Î™ÎÎ¤Î•ÎŸ: $LATEST_LINK"
          echo -e "$LATEST_LINK\n$(cat $FILE)" > "$FILE"
          echo "âœ… Î¤Î¿ links.txt ÎµÎ½Î·Î¼ÎµÏÏÎ¸Î·ÎºÎµ!"

      - name: ÎšÎ¬Î½Îµ commit ÎºÎ±Î¹ push Ï„Î¹Ï‚ Î±Î»Î»Î±Î³Î­Ï‚
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add data/links.txt
          
          # ÎšÎ¬Î½Îµ commit Î¼ÏŒÎ½Î¿ Î±Î½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±Î»Î»Î±Î³Î­Ï‚
          if git diff --staged --quiet; then
            echo "â„¹ï¸  Î§Ï‰ÏÎ¯Ï‚ Î±Î»Î»Î±Î³Î­Ï‚ Î³Î¹Î± commit."
          else
            git commit -m "Î‘Ï…Ï„ÏŒÎ¼Î±Ï„Î¿ update: ÎÎ­Î¿ Î²Î¯Î½Ï„ÎµÎ¿ ÏƒÏ„Î¿ ÎºÎ±Î½Î¬Î»Î¹"
            git push
            echo "ğŸš€ ÎŸÎ¹ Î±Î»Î»Î±Î³Î­Ï‚ Î±Î½Î­Î²Î·ÎºÎ±Î½ ÏƒÏ„Î¿ GitHub!"
          fi
