name: Î‘Ï…Ï„ÏŒÎ¼Î±Ï„Î· ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ· links.txt Î±Ï€ÏŒ YouTube RSS

on:
  schedule:
    - cron: '0 * * * *'  # Î¤ÏÎ­Ï‡ÎµÎ¹ ÎºÎ¬Î¸Îµ 1 ÏÏÎ± (ÏƒÏ„Î¿ Î»ÎµÏ€Ï„ÏŒ 0)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-links:
    runs-on: ubuntu-latest
    steps:
      - name: ÎšÎ±Ï„Î­Î²Î±ÏƒÎ¼Î± repository
        uses: actions/checkout@v4

      - name: Î’ÏÎµÏ‚ Ï„Î¿ Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Î¿ Î²Î¯Î½Ï„ÎµÎ¿ Î±Ï€ÏŒ Ï„Î¿ RSS
        id: get_video
        run: |
          CHANNEL_ID="UCMiJRAwDNSNzuYeN2uWa0pA"
          RSS_URL="https://www.youtube.com/feeds/videos.xml?channel_id=${CHANNEL_ID}"
          
          echo "Î”Î¹Î±Î²Î¬Î¶Ï‰ Ï„Î¿ RSS Î±Ï€ÏŒ: $RSS_URL"
          
          # ÎšÎ±Ï„Î­Î²Î±ÏƒÎµ Ï„Î¿ RSS ÎºÎ±Î¹ Î²Î³Î¬Î»Îµ Ï„Î¿ link Ï„Î¿Ï… Ï€ÏÏÏ„Î¿Ï… (Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Î¿Ï…) Î²Î¯Î½Ï„ÎµÎ¿
          RSS_CONTENT=$(curl -s "$RSS_URL")
          
          # ÎœÎ­Î¸Î¿Î´Î¿Ï‚ 1: ÎœÎµ grep (Ï€Î¹Î¿ Î±Ï€Î»Î®)
          LATEST_URL=$(echo "$RSS_CONTENT" | grep -o 'https://www.youtube.com/watch?v=[^"]*' | head -1)
          
          # ÎœÎ­Î¸Î¿Î´Î¿Ï‚ 2: ÎœÎµ xml Î±Î½ Î±Ï€Î¿Ï„ÏÏ‡ÎµÎ¹ Ï„Î¿ grep
          if [ -z "$LATEST_URL" ]; then
            echo "âš ï¸  Î¤Î¿ grep Î´ÎµÎ½ Î²ÏÎ®ÎºÎµ link, Î´Î¿ÎºÎ¹Î¼Î¬Î¶Ï‰ ÎµÎ½Î±Î»Î»Î±ÎºÏ„Î¹ÎºÎ®..."
            LATEST_URL=$(echo "$RSS_CONTENT" | grep -oP '(?<=<link rel="alternate" href=")[^"]+' | head -1)
          fi
          
          # ÎœÎ­Î¸Î¿Î´Î¿Ï‚ 3: Î‘Î½ Î±ÎºÏŒÎ¼Î± Î´ÎµÎ½ Î²ÏÎ®ÎºÎµ, Î´Î¿ÎºÎ¯Î¼Î±ÏƒÎµ Î¼Îµ awk
          if [ -z "$LATEST_URL" ]; then
            echo "âš ï¸  Î”Î¿ÎºÎ¹Î¼Î¬Î¶Ï‰ Î¼Îµ awk..."
            LATEST_URL=$(echo "$RSS_CONTENT" | awk -F 'href="' '/<link rel="alternate"/ {print $2}' | awk -F '"' '{print $1}' | head -1)
          fi
          
          if [ -z "$LATEST_URL" ]; then
            echo "âŒ Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ link ÏƒÏ„Î¿ RSS"
            echo "Î ÎµÏÎ¹ÎµÏ‡ÏŒÎ¼ÎµÎ½Î¿ RSS Î³Î¹Î± debugging:"
            echo "$RSS_CONTENT" | head -20
            exit 1
          fi
          
          echo "âœ… Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯Î¿ Î²Î¯Î½Ï„ÎµÎ¿: $LATEST_URL"
          echo "LATEST_URL=${LATEST_URL}" >> $GITHUB_OUTPUT

      - name: ÎˆÎ»ÎµÎ³Î¾Îµ ÎºÎ±Î¹ ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎµ Ï„Î¿ links.txt
        env:
          LATEST_LINK: ${{ steps.get_video.outputs.LATEST_URL }}
        run: |
          FILE="data/links.txt"
          
          # Î”Î·Î¼Î¹Î¿ÏÏÎ³Î·ÏƒÎµ Ï„Î¿ Ï†Î¬ÎºÎµÎ»Î¿ data Î±Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹
          mkdir -p data
          
          # Î‘Î½ Ï„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹, Î´Î·Î¼Î¹Î¿ÏÏÎ³Î·ÏƒÎ­ Ï„Î¿
          if [ ! -f "$FILE" ]; then
            echo "ğŸ“ Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ Î±ÏÏ‡ÎµÎ¯Î¿. Î¤Î¿ Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Ï..."
            echo "$LATEST_LINK" > "$FILE"
            echo "âœ… Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î®Î¸Î·ÎºÎµ Î¼Îµ Ï„Î¿ Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Î¿ link."
            exit 0
          fi
          
          # Î”Î¹Î¬Î²Î±ÏƒÎµ ÏŒÎ»Î¿ Ï„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿
          EXISTING_LINKS=$(cat "$FILE")
          
          # ÎˆÎ»ÎµÎ³Î¾Îµ Î±Î½ Ï„Î¿ Î½Î­Î¿ link Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î—Î”Î— ÏƒÏ„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿
          if echo "$EXISTING_LINKS" | grep -q "$LATEST_LINK"; then
            echo "â„¹ï¸  Î¤Î¿ link Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î®Î´Î· ÏƒÏ„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿. ÎšÎ±Î½Î­Î½Î± update."
            exit 0
          fi
          
          # Î‘Î½ ÎµÎ¯Î½Î±Î¹ Î½Î­Î¿ link, Ï€ÏÏŒÏƒÎ¸ÎµÏƒÎ­ Ï„Î¿ ÏƒÏ„Î·Î½ Î±ÏÏ‡Î®
          echo "ğŸ‰ ÎÎ•ÎŸ Î’Î™ÎÎ¤Î•ÎŸ: $LATEST_LINK"
          echo -e "$LATEST_LINK\n$EXISTING_LINKS" > "$FILE"
          echo "âœ… Î¤Î¿ links.txt ÎµÎ½Î·Î¼ÎµÏÏÎ¸Î·ÎºÎµ!"

      - name: ÎšÎ¬Î½Îµ commit ÎºÎ±Î¹ push Ï„Î¹Ï‚ Î±Î»Î»Î±Î³Î­Ï‚
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add data/links.txt
          
          # ÎšÎ¬Î½Îµ commit Î¼ÏŒÎ½Î¿ Î±Î½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±Î»Î»Î±Î³Î­Ï‚
          if git diff --staged --quiet; then
            echo "â„¹ï¸  Î§Ï‰ÏÎ¯Ï‚ Î±Î»Î»Î±Î³Î­Ï‚ Î³Î¹Î± commit."
          else
            git commit -m "Î‘Ï…Ï„ÏŒÎ¼Î±Ï„Î¿ update: ÎÎ­Î¿ Î²Î¯Î½Ï„ÎµÎ¿ ÏƒÏ„Î¿ ÎºÎ±Î½Î¬Î»Î¹"
            git push
            echo "ğŸš€ ÎŸÎ¹ Î±Î»Î»Î±Î³Î­Ï‚ Î±Î½Î­Î²Î·ÎºÎ±Î½ ÏƒÏ„Î¿ GitHub!"
          fi
